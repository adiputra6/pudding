#!/bin/bash
set -o pipefail

aws ec2 describe-instances \
  --filters Name=tag-value,Values=worker \
            Name=instance-state-name,Values=running | \
  jq -r ".Reservations | .[] |
    .Instances | .[] |
    select(.Tags != null) |
    select(.Tags | .[] | .Value == \"worker\") |
    [(.Tags | .[] | select(.Key == \"Name\") | .Value), .InstanceId, .PublicIpAddress, .LaunchTime] |
    join(\" \")
  " | \
  grep -E '\-(docker|testing)' | \
  sort -k3 | \
  exec grep org-${1:-test}
