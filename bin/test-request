#!/usr/bin/env bash

: ${HOST:=http://localhost}
: ${PORT:=42151}
: ${WORKER_MANAGER_AUTH_TOKEN:=swordfish}

case "$1" in
  instance-build)
    exec curl \
      -H "Authorization: token ${WORKER_MANAGER_AUTH_TOKEN}" \
      -X POST \
      -d "{
          \"instance_builds\": {
          \"count\": 1,
          \"site\": \"org\",
          \"env\": \"test\",
          \"queue\": \"docker\",
          \"instance_type\": \"c3.4xlarge\"
        }
      }" \
      ${HOST}:${PORT}/instance-builds
    ;;
  bogus-instance-build)
    exec curl \
      -H "Authorization: token ${WORKER_MANAGER_AUTH_TOKEN}" \
      -X POST \
      -d "{\"instance_builds\": {}}" \
      ${HOST}:${PORT}/instance-builds
    ;;
  shutdown)
    exec curl \
      -H "Authorization: token ${WORKER_MANAGER_AUTH_TOKEN}" \
      -X DELETE \
      ${HOST}:${PORT}/
    ;;
  *)
    echo "unknown request type '$1'"
    ;;
esac
